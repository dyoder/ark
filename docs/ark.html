<!DOCTYPE html>  <html> <head>   <title>ark.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ark.html">                 ark.coffee               </a>                                           <a class="source" href="cli.html">                 cli.coffee               </a>                                           <a class="source" href="module.html">                 module.coffee               </a>                                           <a class="source" href="static.html">                 static.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               ark.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Implements the main commands - <code>package</code> and <code>manifest</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Ark's basic strategy is to bundle up a sort of virtual filesystem so that
Node's module loading will basically work without changes. The <code>manifest</code>
command gives you a list of the files that will be included in this virtual
filesystem. The <code>package</code> command takes a manifest (either one generated on
the fly or provided via the command line) and turns into a JavaScript file
that can be loaded into the browser.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Native Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Some utility functions. Most of these just improve readability. Some of
these should probably be in their own file, esp. since they show up
repeatedly in other files.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Util = </span><span class="nx">require</span> <span class="s2">&quot;util&quot;</span>

<span class="nv">inspect = </span><span class="nf">(thing) -&gt;</span> <span class="nx">Util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">thing</span><span class="p">)</span>

<span class="nv">print = </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="nv">error = </span><span class="nf">(message) -&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>

<span class="nv">warn = </span><span class="nf">(message) -&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{message}\n&quot;</span>

<span class="nv">read = </span><span class="nf">(path) -&gt;</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="nv">readdir = </span><span class="nf">(path) -&gt;</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>

<span class="nv">stat = </span><span class="nf">(path) -&gt;</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>

<span class="nv">Crypto = </span><span class="nx">require</span> <span class="s2">&quot;crypto&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We md5 the file content and store it in a separate hash instead of storing
it directly, which ensures we never store the same file twice (which might
happen if the same package was installed in two different places - which
could happen, especially since we intentionally don't traverse symlinks when
resolving package locations).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">md5 = </span><span class="nf">(string) -&gt;</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">string</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We base64 stuff to avoid having to worry about what's in the files. That way
people can package up whatever they want and not worry about it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">base64 = </span><span class="nf">(string) -&gt;</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">string</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span>

<span class="nv">FileSystem = </span><span class="nx">require</span> <span class="s2">&quot;fs&quot;</span>
<span class="nv">Path = </span><span class="nx">require</span> <span class="s2">&quot;path&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Package Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>We use fibers to make <code>glob</code> synchronous - see below.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Fibers = </span><span class="nx">require</span> <span class="s2">&quot;fibers&quot;</span>
<span class="nv">Future = </span><span class="nx">require</span> <span class="s2">&quot;fibers/future&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>Note</strong> You have to be running in a Fiber for this to work.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">make_synchronous = </span><span class="nf">(fn) -&gt;</span>
  <span class="nv">fn = </span><span class="nx">Future</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">fn</span>
  <span class="o">-&gt;</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">arguments</span><span class="p">...).</span><span class="nx">wait</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Take any function and run it as a fiber. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">run_as_fiber = </span><span class="nf">(fn) -&gt;</span>
  <span class="o">-&gt;</span>
    <span class="nv">_arguments = </span><span class="nx">arguments</span>
    <span class="nx">Fiber</span><span class="p">(</span> <span class="o">-&gt;</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">_arguments</span><span class="p">...)</span> <span class="p">).</span><span class="nx">run</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We use <code>eco</code> as a template engine when generating code.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Eco = </span><span class="nx">require</span> <span class="s2">&quot;eco&quot;</span>
<span class="nv">render = </span><span class="nf">(template,context) -&gt;</span> <span class="nx">Eco</span><span class="p">.</span><span class="nx">render</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">context</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>We also want to do on-the-fly CoffeeScript compilation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CoffeeScript = </span><span class="nx">require</span> <span class="s2">&quot;coffee-script&quot;</span>
<span class="nv">compile_coffeescript = </span><span class="nf">(source) -&gt;</span> <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">source</span><span class="p">,</span> <span class="nv">bare: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>We use <code>uglify-js</code> to minify the code. This elaborate way of defining
<code>minify</code> just keeps the number of variables to a minimum.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">minify = </span><span class="p">(</span><span class="o">-&gt;</span>
  <span class="p">{</span><span class="nx">parser</span><span class="p">,</span><span class="nx">uglify</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;uglify-js&quot;</span>
  <span class="nf">(code) -&gt;</span>
    <span class="nv">ast = </span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">code</span>
    <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_mangle</span> <span class="nx">ast</span>
    <span class="nv">ast = </span><span class="nx">uglify</span><span class="p">.</span><span class="nx">ast_squeeze</span> <span class="nx">ast</span>
    <span class="nx">uglify</span><span class="p">.</span><span class="nx">gen_code</span> <span class="nx">ast</span>
<span class="p">)()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The <code>glob</code> package just returns the <code>glob</code> function, so we just make it
synchronous.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">glob = </span><span class="nx">make_synchronous</span> <span class="nx">require</span> <span class="s2">&quot;glob&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>Local Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This is actually just adapted from <a href="https://github.com/einars/js-beautify">js-beautify</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">beautify = </span><span class="p">(</span><span class="o">-&gt;</span>
  <span class="nv">_beautify = </span><span class="nx">require</span> <span class="s2">&quot;./beautify&quot;</span>
  <span class="nf">(code) -&gt;</span> <span class="nx">_beautify</span> <span class="nx">code</span><span class="p">,</span> <span class="nv">indent_size: </span><span class="mi">2</span>
<span class="p">)()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The <a href="static.html">local <code>static</code> module</a> performs static dependency analysis.
Basically, we get back an array containing two other arrays. The first is a
list of file paths of all the files that were necessary to resolve the
<code>require</code> statements. The second is the list of native modules that are
necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">dependencies</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;./static&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Helper Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>The <code>manifest</code> function returns a <em>manifest</em>, a Javascript object describing
the original source directory used to generate the manifest, a list of files
to include, and a list of native modules to include.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">manifest = </span><span class="nf">(options) -&gt;</span>

  <span class="p">{</span><span class="nx">source</span><span class="p">,</span><span class="nx">extensions</span><span class="p">}</span> <span class="o">=</span> <span class="nx">options</span>

  <span class="nv">source = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">source</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>There are two ways to generate a manifest: static dependency analysis (SDA)
and crawling the filesystem. The former should almost always be used in
production, but you could use the latter method and then manually strip it
down. This is particularly useful if you want to include non-source files
(although, <code>.json</code> files are also included).</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>ack, suddenly wrapping text isn't working ...</p>             </td>             <td class="code">               <div class="highlight"><pre>      
  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">static</span><span class="o">?</span> </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>We start by getting the dependencies based on the package.json in the source
directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">[</span><span class="nx">paths</span><span class="p">,</span><span class="nx">native_modules</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dependencies</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Make sure we add any package.json files, since these aren't returned as
dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">paths = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">glob</span> <span class="s2">&quot;#{source}/**/*.json&quot;</span><span class="p">,</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Make sure that we have the bare minimum native modules required to support
module loading - but don't add them if they're already there.   </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">module</span> <span class="k">in</span> <span class="s2">&quot;assert util path fs module&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
      <span class="nx">native_modules</span><span class="p">.</span><span class="nx">push</span> <span class="nx">module</span> <span class="nx">unless</span> <span class="nx">module</span> <span class="k">in</span> <span class="nx">native_modules</span>
  <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If we just want to crawl the filesystem instead of doing SDA, we just let
glob do all the real work.    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">paths = </span><span class="nx">glob</span> <span class="s2">&quot;#{source}/**/*.{#{extensions}}&quot;</span><span class="p">,</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Then we just load all the native modules that we can support by looking in
the local source directory. All the native modules are in the "node"
directory.  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">native_modules = </span><span class="k">for</span> <span class="nx">filename</span> <span class="k">in</span> <span class="p">(</span><span class="nx">readdir</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Make sure to remove the extension to get the actual module name.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">extension = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">filename</span>
      <span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">filename</span><span class="p">,</span> <span class="nx">extension</span>
      </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Next, we want to convert the paths to paths in the virtual filesystem we're
going to be packaging up, where <code>/</code> is the source directory itself.  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">files = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>How many of the path components are just needed to get us to the source
directory? We want to remove them from our virtual filesystem paths, since
the source directory maps to <code>/</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">n = </span><span class="nx">source</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="nx">length</span>
  <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">paths</span>
    <span class="nv">_path = </span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[(</span><span class="nx">n</span><span class="p">)..].</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="nx">files</span><span class="p">.</span><span class="nx">push</span> <span class="nx">_path</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>And that's a wrap: deliver the manifest.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">source: </span><span class="nx">source</span>
  <span class="nv">files: </span><span class="nx">files</span>
  <span class="nv">native_modules: </span><span class="nx">native_modules</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The <code>index</code> function takes a manifest and returns the JavaScript object
representing our virtual filesystem. The name <code>index</code> is a bit of misnomer
and should probably be changed to <code>filesystem</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The trick here is that we want to actually include real functions, not just
strings of the source code. We also don't want to accidentally store
anything twice, because we want to keep our bandwidth use to a minimum.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>In order to accomplish these goals we create references by hashing the
content and storing that in separate content hash. If the content appears to
be source code, we actually replace the source code with the hash and
dereference it using yet another hash that stores module functions.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>In other words, if you do a fs.readFile* on a source file, you'll actually
get the hash of the source code back, instead of the source code itself.
From there you can get the corresponding module function. We do this so that
the node Module system can work without significant changes. "Compiling"
source code essentially means derefencing the hash.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">index = </span><span class="nf">(manifest) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Here's the data structure we're going to populate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">filesystem = </span>
    <span class="nv">root: </span><span class="p">{}</span>
    <span class="nv">content: </span><span class="p">{}</span>
    <span class="nv">native_modules: </span><span class="p">{}</span>
    <span class="nv">module_functions: </span><span class="p">{}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Define a few helper functions that are specific to this function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Resolve a path relative to the source directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolve = </span><span class="nf">(paths...) -&gt;</span>
    <span class="nx">Path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">manifest</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span><span class="nx">paths</span><span class="p">...)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Generate the code for a module function. We include the path so that we can
embed it as a comment in the source, which might help with debugging.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">template = </span><span class="nx">read</span><span class="p">(</span><span class="s2">&quot;#{__dirname}/templates/module.js&quot;</span><span class="p">)</span>
  <span class="nv">module_function = </span><span class="nf">(code,path) -&gt;</span>
    <span class="nx">render</span> <span class="nx">template</span><span class="p">,</span> <span class="nv">code: </span><span class="nx">code</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Set up a hash of compilers based on the extension. This is the beginnings of
a more extensible mechanism.  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">identity = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span>
  <span class="nv">compilers = </span>
    <span class="s2">&quot;.coffee&quot;</span><span class="o">:</span> <span class="nx">compile_coffeescript</span>
    <span class="s2">&quot;.js&quot;</span><span class="o">:</span> <span class="nx">identity</span>
  </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Okay, now we're ready to start processing the manifest. First, we just go
through the files included in the manifest. We're going to produce a nested
a hash that mirrors the filesystem.    </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Grab the directory and filename for this file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">directory = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">path</span>
    <span class="nv">filename = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>The <code>tmp</code> variable here is used as a "current directory" reference. We
start, of course, at the filesystem root.    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">tmp = </span><span class="nx">filesystem</span><span class="p">.</span><span class="nx">root</span>
    </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Just an array of path components that we use to resolve relative paths.
Probably would have been sufficient for this to be a string that we just
keep re-resolving with the last path component.    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cwd = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>If we're in the current directory that means this file is in the root, which
means we can skip navigating down to the right directory (nested hash).    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">directory</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Okay, we're not in the current directory, so we need to navigate down to the
right directory (nested hash).            </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">part</span> <span class="k">in</span> <span class="nx">directory</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Keep track of where we are so we can resolve paths.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">cwd</span><span class="p">.</span><span class="nx">push</span> <span class="o">&lt;&lt;</span> <span class="nx">part</span>
        </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If we haven't encountered this "directory" yet, initialize it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">tmp = </span><span class="nx">tmp</span><span class="p">[</span><span class="nx">part</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Capture the stat info for this directory. Much of this is useless: see
<a href="https://github.com/dyoder/ark/issues/18">issue #18</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">tmp</span><span class="p">.</span><span class="nx">__stat</span> <span class="o">?=</span> <span class="nx">stat</span> <span class="nx">resolve</span> <span class="nx">cwd</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Flag it as a directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">tmp</span><span class="p">.</span><span class="nx">__stat</span><span class="p">.</span><span class="nx">type</span> <span class="o">?=</span>  <span class="s2">&quot;directory&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Okay, now we've navigated to the right "directory", which means that tmp now
points to the directory in which the file belongs. Next, we're going to
generate a reference to the file by hashing it. This also ensures we don't
store the same content twice.        </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">real_path = </span><span class="nx">resolve</span> <span class="nx">path</span>
    <span class="nv">extension = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">path</span>
    <span class="nv">content = </span><span class="nx">read</span> <span class="nx">real_path</span>
    <span class="nv">reference = </span><span class="nx">md5</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Next, if this is source code, we're going to generate a module function and
use the hash itself as a standin for the source code. If it isn't source
code, we just store the content directly. We base64 the content so we don't
have to worry too much about what's in the file.        </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">compilers</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Grab the compiler based on the extension.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">compile = </span><span class="nx">compilers</span><span class="p">[</span><span class="nx">extension</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Add the content to the <code>content</code> hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">(</span><span class="nx">reference</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Generate the module function and add it to the <code>module_functions</code> hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">module_functions</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> 
        <span class="nx">module_function</span> <span class="p">(</span><span class="nx">compile</span> <span class="nx">content</span><span class="p">),</span> <span class="nx">path</span>
    <span class="k">else</span>
      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">base64</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Add the file to it's parent directory, including stat information</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tmp</span><span class="p">[</span><span class="nx">filename</span><span class="p">]</span> <span class="o">=</span>
      <span class="nv">__stat: </span><span class="nx">stat</span> <span class="nx">real_path</span>
      <span class="nv">__ref: </span><span class="nx">reference</span>
    <span class="nx">tmp</span><span class="p">[</span><span class="nx">filename</span><span class="p">].</span><span class="nv">__stat.type = </span><span class="s2">&quot;file&quot;</span>  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>We've now processed all the files, but we still need to add the native
modules. We store these the same way as we store any source: hash the source
code, add the hash to the content directory, and then add the module
function. This uniformity allows us to treat "compiling" source the same
way, with minimal changes to the Node implementation for <code>NativeModule</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>We have to make sure <code>stream</code> is added when <code>http</code> is used. For native
modules, we don't actually do any dependency analysis, so we have to hard
code these kinds of things. All the modules necessary for the module system
itself are added by the <code>manifest</code> helper function. Arguably, this belongs
there as well.    </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="s2">&quot;http&quot;</span> <span class="k">in</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">native_modules</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="s2">&quot;stream&quot;</span> <span class="k">in</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">native_modules</span><span class="p">)</span>
    <span class="nx">warn</span> <span class="s2">&quot;Automatically adding native module &#39;stream&#39; because &#39;http&#39; is being used&quot;</span>
    <span class="nx">manifest</span><span class="p">.</span><span class="nx">native_modules</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;stream&quot;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>So now we have our list of native modules we're going to bundle up.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">manifest</span><span class="p">.</span><span class="nx">native_modules</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>If anything goes wrong, we want to warn the developer.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Resolve the module based on our faux browser modules in the <code>node</code>
directory. That directory should probably be named <code>native_modules</code>.      </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">path = </span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="nx">name</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Read the code at the path we resolved.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">code = </span><span class="nx">read</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Grab the extension, so we know which compiler to use.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">extension = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">extname</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Generate the reference.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">reference = </span><span class="nx">md5</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Instead of adding the reference to the filesystem has, we add it to a
special hash just for native modules.            </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">native_modules</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">reference</span>
      </pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Add the content as hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">content</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> <span class="nx">base64</span> <span class="nx">reference</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Compile the source.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">compile = </span><span class="nx">compilers</span><span class="p">[</span><span class="nx">extension</span><span class="p">]</span>
      </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Generate the module function and add it to the <code>module_functions</code> hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">filesystem</span><span class="p">.</span><span class="nx">module_functions</span><span class="p">[</span><span class="nx">reference</span><span class="p">]</span> <span class="o">=</span> 
        <span class="nx">module_function</span> <span class="nx">compile</span> <span class="nx">code</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nx">warn</span> <span class="s2">&quot;Unable to package native module &#39;#{name}&#39;&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Return the filesystem to the caller.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">filesystem</span>
  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>The <code>code</code> function takes the filesystem and turns it into a Javascript file
based on the <code>node.js</code> template in the <code>templates</code> directory.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">code = </span><span class="nf">(filesystem) -&gt;</span>
  <span class="nv">template = </span><span class="nx">read</span><span class="p">(</span><span class="s2">&quot;#{__dirname}/templates/node.js&quot;</span><span class="p">)</span>
  <span class="nx">render</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">filesystem</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h2>Main Entry Points</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>The <code>ark</code> binary calls into the Ark object based on the subcommand. So we
have a function defined for each subcommand.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Ark =</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>The manifest subcommand basically just calls the <code>manifest</code> helper function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">manifest: </span><span class="nf">(options) -&gt;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Check the options to make sure we can actually run the command. We could
probably do more checking here, although arguably this makes more sense in
the actual <code>manifest</code> helper function, since the validation is different
dependeing on the way the manifest is generated.    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">error</span> <span class="s2">&quot;Please provide source directory via --source option&quot;</span> <span class="nx">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">source</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Generate the manifest from the options, format it, and send it to standard out.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">print</span> <span class="nx">inspect</span> <span class="nx">manifest</span> <span class="nx">options</span>
    
  <span class="nv">package: </span><span class="nf">(options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>We can get the manifest via an option or we can generate one.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">manifest = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">manifest</span>
      <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">read</span> <span class="nx">options</span><span class="p">.</span><span class="nx">manifest</span>
    <span class="k">else</span>
      <span class="nx">manifest</span> <span class="nx">options</span>
      </pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>We process the JavaScript via the <code>index</code> function and then, based on the options
either minify it or beautify it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">print</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">minify</span>
      <span class="nx">minify</span> <span class="nx">code</span> <span class="nx">index</span> <span class="nx">manifest</span>
    <span class="k">else</span>
      <span class="nx">beautify</span> <span class="nx">code</span> <span class="nx">index</span> <span class="nx">manifest</span>
      </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>We wrap the subcommand functions in fibers so we can use fibers within the
implementation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Ark.manifest = </span><span class="nx">run_as_fiber</span> <span class="nx">Ark</span><span class="p">.</span><span class="nx">manifest</span>
<span class="nv">Ark.package = </span><span class="nx">run_as_fiber</span> <span class="nx">Ark</span><span class="p">.</span><span class="nx">package</span>

<span class="nv">module.exports = </span><span class="nx">Ark</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 