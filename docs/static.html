<!DOCTYPE html>  <html> <head>   <title>static.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ark.html">                 ark.coffee               </a>                                           <a class="source" href="cli.html">                 cli.coffee               </a>                                           <a class="source" href="module.html">                 module.coffee               </a>                                           <a class="source" href="static.html">                 static.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               static.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>We return a list of pathnames based on static dependency analysis.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Native Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">FileSystem = </span><span class="nx">require</span> <span class="s2">&quot;fs&quot;</span>
<span class="nv">read = </span><span class="nf">(path) -&gt;</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nv">print = </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span>

<span class="p">{</span><span class="nx">dirname</span><span class="p">,</span><span class="nx">basename</span><span class="p">,</span><span class="nx">extname</span><span class="p">,</span><span class="nx">join</span><span class="p">,</span><span class="nx">resolve</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s2">&quot;path&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Package Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Detective does the heavy-lifting of actually parsing the JavaScript files
and finding the <code>require</code> statements.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">detective = </span><span class="nx">require</span> <span class="s2">&quot;detective&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We need to compile the CoffeeScript we encounter so that detective knows
what to do with it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CoffeeScript = </span><span class="nx">require</span> <span class="s2">&quot;coffee-script&quot;</span>
<span class="nv">compile = </span><span class="nf">(source) -&gt;</span> <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Local Modules</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We have our [local version of Module][local-module]. That should probably be
renamed to avoid confusion. We use three functions: <code>_nodeModulePaths</code> (when
constructing modules), <code>_resolveFilename</code>, and <code>_isNative</code>. The underscores
are misleading, since they aren't really private functions (which is partly
why we have our own version instead of just using Node's <code>module</code> package
directly.)
[local-module][./module.html]</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Module = </span><span class="nx">require</span> <span class="s2">&quot;./module&quot;</span>
<span class="nv">module_paths = </span><span class="nx">Module</span><span class="p">.</span><span class="nx">_nodeModulePaths</span>
<span class="nv">resolve_filename = </span><span class="nx">Module</span><span class="p">.</span><span class="nx">_resolveFilename</span>
<span class="nv">native_module = </span><span class="nf">(path) -&gt;</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">_isNative</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Helper Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>A conveniet way to read <code>package.json</code> files. Returns the JavaScript object
associated with the package file.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">read_package = </span><span class="nf">(path) -&gt;</span>
  <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">read</span> <span class="nx">resolve</span> <span class="nx">path</span><span class="p">,</span><span class="s2">&quot;package.json&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Simple utility function to ensure we don't return duplicate dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">uniq = </span><span class="nf">(array) -&gt;</span>
  <span class="nv">hash = </span><span class="p">{}</span>
  <span class="nx">hash</span><span class="p">[</span><span class="nx">element</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span> <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">array</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Construct a module and assign it the correct filename and paths. For some
reason, there's nothing in Module that does precisely this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">create_module = </span><span class="nf">(path,parent) -&gt;</span>

  <span class="nv">directory = </span><span class="nx">dirname</span> <span class="nx">path</span>
  <span class="nv">extension = </span><span class="nx">extname</span> <span class="nx">path</span>
  <span class="nv">id = </span><span class="nx">join</span> <span class="nx">directory</span><span class="p">,</span> <span class="p">(</span><span class="nx">basename</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">extension</span><span class="p">)</span>

  <span class="nv">module = </span><span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">parent</span><span class="p">)</span>
  <span class="nv">module.filename = </span><span class="nx">path</span>
  <span class="nv">module.paths = </span><span class="nx">module_paths</span> <span class="nx">directory</span>

  <span class="nx">module</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>The <code>dependencies</code> Function</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>And now for the main event. We take a path and return a list of
dependencies. We find the dependencies by starting with the package <code>main</code>
file and then taking it's dependencies and checking them, and so on, until
there's no more files to check. Currently, we don't check for cycles,
although they'd still be possible even if we did, because our version of
Module doesn't resolve symlinks.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">dependencies = </span><span class="nf">(path) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Start with the <code>main</code> file of the package.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">path = </span><span class="nx">resolve</span> <span class="nx">path</span><span class="p">,</span> <span class="p">(</span><span class="nx">read_package</span> <span class="nx">path</span><span class="p">).</span><span class="nx">main</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Add the main file to the list of files we'll return. Arguably, the caller
should do this. On the other hand, you could argue that the main file is
itself a dependency. Whatever. For right now, we're doing it here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">paths = </span><span class="p">[</span> <span class="nx">path</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>We're also going to return the list of native modules.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">native_modules = </span><span class="p">[]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The "real" dependency function, which gets called recursively, incorporating
<code>paths</code> and <code>native_modules</code> via closure.  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_dependencies = </span><span class="nf">(path,parent) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>We start by simply reading the source code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">source = </span><span class="nx">read</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We check the extension to see if we need to compile it. Right now, we just
hardcode this for CoffeeScript. We should probably adopt the approach taken
in the <code>[ark.coffee][ark]</code> source.
[ark][./ark.html]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">extname</span> <span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;.coffee&quot;</span>
      <span class="nv">source = </span><span class="nx">compile</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Construct a module for the current file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">module = </span><span class="nx">create_module</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">parent</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Ask detective to give us the dependencies and then, for each one, we're
going to:    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">reference</span> <span class="k">in</span> <span class="p">(</span><span class="nx">detective</span> <span class="nx">source</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <ul>
<li>Get the actual pathname (rather than the reference).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">dependent_path = </span><span class="nx">resolve_filename</span> <span class="nx">reference</span><span class="p">,</span> <span class="nx">module</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <ul>
<li>Check to see if it's a native module.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">native_module</span> <span class="nx">dependent_path</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <ul>
<li>If it's a local package, save the pathname and check it's dependencies.        </li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">paths</span><span class="p">.</span><span class="nx">push</span> <span class="nx">dependent_path</span>
        <span class="nx">_dependencies</span><span class="p">(</span><span class="nx">dependent_path</span><span class="p">,</span><span class="nx">module</span><span class="p">)</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <ul>
<li>Otherwise, add it to the list of native modules.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">native_modules</span><span class="p">.</span><span class="nx">push</span> <span class="nx">dependent_path</span>
        </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Start the recursion, beginning with our package <code>main</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">_dependencies</span> <span class="nx">path</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Remove any duplicates and return the result.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">[(</span><span class="nx">uniq</span> <span class="nx">paths</span><span class="p">),(</span><span class="nx">uniq</span> <span class="nx">native_modules</span><span class="p">)]</span>
    
<span class="nv">module.exports =</span>
  <span class="nv">dependencies: </span><span class="nx">dependencies</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 